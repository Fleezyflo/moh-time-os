name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ============================================================================
  # PRE-COMMIT â€” Runs all configured pre-commit hooks
  # ============================================================================
  pre-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: pip install -e ".[dev]"

      - name: Install Node dependencies
        run: cd time-os-ui && npm ci

      - name: Run pre-commit
        uses: pre-commit/action@2c7f1384262f25e10ea145f39a39c55c25afea11  # v3.0.1

  # ============================================================================
  # PYTHON-GUARDS â€” Semgrep security + project-specific rules
  # ============================================================================
  python-guards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep - Security rules
        run: |
          semgrep --config p/python \
            --config p/security-audit \
            --config .semgrep/moh-time-os-rules.yaml \
            --error \
            --json \
            --output semgrep-results.json \
            lib/ api/ collectors/ scripts/ \
            || true  # Continue to show summary even on findings

      - name: Semgrep Summary
        run: |
          echo "## Semgrep Results" >> $GITHUB_STEP_SUMMARY
          if [ -f semgrep-results.json ]; then
            FINDINGS=$(jq '.results | length' semgrep-results.json)
            echo "Total findings: $FINDINGS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FINDINGS" -gt 0 ]; then
              echo "### Findings by Rule" >> $GITHUB_STEP_SUMMARY
              jq -r '.results | group_by(.check_id) | .[] | "- \(.[0].check_id): \(length)"' semgrep-results.json >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  # ============================================================================
  # SECURITY-SCAN â€” CVE checks, secrets, forbidden files
  # ============================================================================
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install pip-audit detect-secrets

      - name: "ðŸ”’ CVE Check - pip-audit"
        run: |
          pip install -e ".[dev]"
          pip-audit --strict --desc on || {
            echo "::error::Vulnerable dependencies detected"
            exit 1
          }

      - name: "ðŸ” Secrets Check - detect-secrets"
        run: |
          # Scan for new secrets not in baseline
          detect-secrets scan \
            --exclude-files '\.lock$' \
            --exclude-files 'node_modules' \
            --exclude-files '\.venv' \
            --exclude-files '_archive' \
            --all-files > /tmp/current-secrets.json
          
          # Compare with baseline
          if [ -f .secrets.baseline ]; then
            BASELINE_COUNT=$(jq '.results | to_entries | map(.value | length) | add // 0' .secrets.baseline)
            CURRENT_COUNT=$(jq '.results | to_entries | map(.value | length) | add // 0' /tmp/current-secrets.json)
            
            if [ "$CURRENT_COUNT" -gt "$BASELINE_COUNT" ]; then
              echo "::error::New secrets detected! Baseline: $BASELINE_COUNT, Current: $CURRENT_COUNT"
              echo "New secrets found in:"
              jq -r '.results | to_entries[] | select(.value | length > 0) | .key' /tmp/current-secrets.json
              exit 1
            fi
          fi
          echo "âœ… No new secrets detected"

      - name: "ðŸ—„ï¸ Forbidden Files Check"
        run: |
          ERRORS=0
          
          # Check for database files
          DB_FILES=$(find . -name "*.db" -o -name "*.sqlite" -o -name "*.sqlite3" 2>/dev/null | grep -v node_modules | grep -v .venv || true)
          if [ -n "$DB_FILES" ]; then
            echo "::error::Database files found in repo:"
            echo "$DB_FILES"
            ERRORS=$((ERRORS + 1))
          fi
          
          # Check for *-full.json data dumps
          DUMP_FILES=$(find . -name "*-full.json" 2>/dev/null | grep -v node_modules | grep -v .venv || true)
          if [ -n "$DUMP_FILES" ]; then
            echo "::error::Data dump files found in repo:"
            echo "$DUMP_FILES"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "âœ… No forbidden files found"

      - name: "ðŸ“ Monolith File Check (max 3000 lines)"
        run: |
          ERRORS=0
          
          for f in $(find lib/ api/ -name "*.py" 2>/dev/null); do
            LINES=$(wc -l < "$f")
            if [ "$LINES" -gt 3000 ]; then
              echo "::error::$f has $LINES lines (max 3000)"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Files exceeding 3000 lines must be split"
            exit 1
          fi
          echo "âœ… No monolith files detected"

      - name: "ðŸ“‹ Gitignore Coverage Check"
        run: |
          REQUIRED_PATTERNS=(
            "*.db"
            "*.sqlite"
            "*.sqlite3"
            ".env"
            "*-full.json"
            "__pycache__"
            ".venv"
            "node_modules"
          )
          
          MISSING=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -qE "^${pattern//\*/.*}$|^${pattern}$" .gitignore 2>/dev/null; then
              echo "::warning::Missing .gitignore pattern: $pattern"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ "$MISSING" -gt 0 ]; then
            echo "::error::$MISSING required patterns missing from .gitignore"
            exit 1
          fi
          echo "âœ… All required .gitignore patterns present"

  # ============================================================================
  # ROUTE-INTEGRITY â€” Check for duplicate routes and report endpoint stats
  # ============================================================================
  route-integrity:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: "ðŸ”€ Extract and Check Routes"
        run: |
          python3 << 'EOF'
          import re
          import sys
          from pathlib import Path
          from collections import defaultdict
          
          # Find all Python files in api/
          api_files = list(Path("api").rglob("*.py"))
          
          # Pattern for route decorators
          route_pattern = re.compile(
              r'@(?:app|router)\.(get|post|put|delete|patch)\s*\(\s*["\']([^"\']+)["\']',
              re.IGNORECASE
          )
          
          # Extract all routes
          routes = []
          for f in api_files:
              content = f.read_text()
              for match in route_pattern.finditer(content):
                  method = match.group(1).upper()
                  path = match.group(2)
                  routes.append((method, path, str(f)))
          
          # Check for duplicates
          route_map = defaultdict(list)
          for method, path, file in routes:
              route_map[(method, path)].append(file)
          
          duplicates = {k: v for k, v in route_map.items() if len(v) > 1}
          
          # Count unprotected write endpoints
          unprotected = 0
          for method, path, _ in routes:
              if method in ("POST", "PUT", "DELETE", "PATCH"):
                  # Simple heuristic - proper auth check would need AST parsing
                  unprotected += 1
          
          # Report
          print(f"## Route Integrity Report")
          print(f"Total endpoints: {len(routes)}")
          print(f"Write endpoints (POST/PUT/DELETE/PATCH): {unprotected}")
          print(f"Duplicate routes: {len(duplicates)}")
          
          if duplicates:
              print("\n### âŒ Duplicate Routes Found:")
              for (method, path), files in duplicates.items():
                  print(f"- {method} {path}")
                  for f in files:
                      print(f"  - {f}")
              sys.exit(1)
          else:
              print("\nâœ… No duplicate routes")
          EOF

      - name: "ðŸ“Š Route Stats Summary"
        if: always()
        run: |
          echo "## Route Statistics" >> $GITHUB_STEP_SUMMARY
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import re
          from pathlib import Path
          from collections import Counter
          
          api_files = list(Path("api").rglob("*.py"))
          route_pattern = re.compile(r'@(?:app|router)\.(get|post|put|delete|patch)\s*\(', re.IGNORECASE)
          
          methods = []
          for f in api_files:
              content = f.read_text()
              for match in route_pattern.finditer(content):
                  methods.append(match.group(1).upper())
          
          counts = Counter(methods)
          print(f"| Method | Count |")
          print(f"|--------|-------|")
          for method in ["GET", "POST", "PUT", "DELETE", "PATCH"]:
              print(f"| {method} | {counts.get(method, 0)} |")
          print(f"| **Total** | **{sum(counts.values())}** |")
          EOF

  # ============================================================================
  # RATCHET â€” Ensure metrics don't regress
  # ============================================================================
  ratchet:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: "ðŸ“‰ Ratchet Check"
        run: |
          python scripts/ratchet_check.py
          
      - name: "ðŸ“Š Ratchet Summary"
        if: always()
        run: |
          echo "## Ratchet Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f .ratchet-baseline.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat .ratchet-baseline.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # TEST â€” Run Python test suite
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -v --tb=short

  # ============================================================================
  # BUILD-UI â€” TypeScript checks and production build
  # ============================================================================
  build-ui:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: '20'

      - name: Install dependencies
        run: cd time-os-ui && npm ci

      - name: Type check
        run: cd time-os-ui && npm run typecheck

      - name: Lint
        run: cd time-os-ui && npm run lint

      - name: Build
        run: cd time-os-ui && npm run build

      - name: Bundle size check
        run: |
          cd time-os-ui
          JS_SIZE=$(du -sk dist/assets/*.js 2>/dev/null | awk '{sum+=$1} END {print sum}')
          CSS_SIZE=$(du -sk dist/assets/*.css 2>/dev/null | awk '{sum+=$1} END {print sum}')
          TOTAL=$((JS_SIZE + CSS_SIZE))
          
          echo "Bundle sizes: JS=${JS_SIZE}KB, CSS=${CSS_SIZE}KB, Total=${TOTAL}KB"
          
          # Fail if bundle exceeds 1MB
          if [ "$TOTAL" -gt 1024 ]; then
            echo "::error::Bundle size ${TOTAL}KB exceeds 1MB limit"
            exit 1
          fi
# Test comment - CODEOWNER verification Tue Feb 17 13:41:07 +04 2026

name: Nightly

on:
  schedule:
    # Run at 3 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ==========================================
  # COVERAGE
  # ==========================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run coverage
        run: |
          uv run pytest tests/ \
            --cov=lib --cov=api \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-fail-under=40 \
            -v --tb=short

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ==========================================
  # BENCHMARKS
  # ==========================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run benchmarks
        run: uv run python scripts/benchmark.py --save benchmarks.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmarks.json

      - name: Check for regressions
        run: |
          if [ -f "benchmarks-baseline.json" ]; then
            uv run python scripts/benchmark.py --compare benchmarks-baseline.json
          else
            echo "No baseline found, skipping regression check"
          fi

  # ==========================================
  # DB LIFECYCLE
  # ==========================================
  db-lifecycle:
    name: DB Lifecycle Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run DB lifecycle tests
        run: uv run pytest tests/lifecycle/ -v --tb=short

  # ==========================================
  # SECURITY DEEP SCAN
  # ==========================================
  security-deep:
    name: Security Deep Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run full security audit
        run: ./scripts/security_audit.sh

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: docs/sbom/

  # ==========================================
  # MUTATION TESTING
  # ==========================================
  mutation:
    name: Mutation Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run mutation tests (lib/safety)
        run: |
          uv run mutmut run \
            --paths-to-mutate=lib/safety/ \
            --tests-dir=tests/ \
            --runner="python -m pytest tests/test_safety.py -x -q --tb=no" \
            || true

      - name: Report mutation results
        run: uv run mutmut results

      - name: Upload mutation cache
        uses: actions/upload-artifact@v4
        with:
          name: mutmut-cache
          path: .mutmut-cache

  # ==========================================
  # DEAD CODE ANALYSIS
  # ==========================================
  dead-code:
    name: Dead Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Install vulture
        run: uv pip install vulture

      - name: Run dead code analysis
        run: uv run python scripts/check_dead_code.py
        continue-on-error: true

  # ==========================================
  # UI DEEP CHECK
  # ==========================================
  ui-deep:
    name: UI Deep Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: time-os-ui
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run full CI suite
        run: pnpm run ci

      - name: Dependency audit
        run: pnpm audit || true

      - name: Check for unused deps
        run: node scripts/check-deps.js

  # ==========================================
  # FULL MIGRATION MATRIX
  # ==========================================
  migration-matrix:
    name: Full Migration Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run Full Migration Matrix
        run: uv run python scripts/migrate_matrix.py --full

      - name: Run Rollback Drill
        run: uv run python scripts/rollback_drill.py

  # ==========================================
  # SEMGREP DEEP SCAN
  # ==========================================
  semgrep:
    name: Semgrep Deep Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Run Semgrep Security Rules (gating)
        run: |
          uv run semgrep --version
          uv run semgrep --config .semgrep/security-rules.yaml lib/ api/ --error

      - name: Run Semgrep Full Rules (advisory)
        run: uv run semgrep --config .semgrep/rules.yaml lib/ api/ --severity ERROR
        continue-on-error: true

      - name: Run Semgrep Auto Rules (advisory)
        run: uv run semgrep --config auto lib/ api/ --error
        continue-on-error: true

  # ==========================================
  # EVIDENCE BUNDLE
  # ==========================================
  evidence-bundle:
    name: Evidence Bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          uv sync --all-extras
          cd time-os-ui && pnpm install

      - name: Generate Evidence Bundle
        run: uv run python scripts/evidence_bundle.py || true

      - name: Upload Evidence
        uses: actions/upload-artifact@v4
        with:
          name: evidence-bundle
          path: evidence/

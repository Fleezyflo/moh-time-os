rules:
  # ============================================================================
  # Python Rules
  # ============================================================================

  - id: no-shell-true
    patterns:
      - pattern-either:
          - pattern: subprocess.run(..., shell=True, ...)
          - pattern: subprocess.call(..., shell=True, ...)
          - pattern: subprocess.Popen(..., shell=True, ...)
    message: "Avoid shell=True. Use list args instead for security."
    languages: [python]
    severity: ERROR
    paths:
      include:
        - lib/
        - api/
        - scripts/

  - id: no-os-system
    pattern: os.system(...)
    message: "Avoid os.system(). Use subprocess with list args instead."
    languages: [python]
    severity: ERROR
    paths:
      include:
        - lib/
        - api/
        - scripts/

  - id: no-dynamic-sql-fstring
    patterns:
      - pattern: |
          $CURSOR.execute(f"...", ...)
      - pattern: |
          $CONN.execute(f"...", ...)
    message: "Avoid f-strings in SQL. Use parameterized queries."
    languages: [python]
    severity: ERROR
    paths:
      include:
        - lib/
        - api/

  - id: no-eval
    pattern-either:
      - pattern: eval(...)
      - pattern: exec(...)
    message: "Avoid eval/exec. Use safe alternatives."
    languages: [python]
    severity: ERROR
    paths:
      include:
        - lib/
        - api/

  - id: subprocess-use-which
    patterns:
      - pattern: subprocess.run([$CMD, ...], ...)
      - pattern-not: subprocess.run([shutil.which(...), ...], ...)
      - metavariable-regex:
          metavariable: $CMD
          regex: ^["'][a-z]+["']$
    message: "Consider using shutil.which() for command resolution."
    languages: [python]
    severity: WARNING
    paths:
      include:
        - lib/
        - api/
        - scripts/

  # ============================================================================
  # TypeScript/JavaScript Rules (UI)
  # ============================================================================

  - id: no-direct-fetch-ui
    patterns:
      - pattern: fetch(...)
      - pattern-not-inside: |
          // @allow-fetch
          ...
    message: "Direct fetch() is banned. Use src/api/http.ts instead."
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - time-os-ui/src/
      exclude:
        - time-os-ui/src/api/
        - time-os-ui/src/__tests__/

  - id: no-axios
    pattern: axios.$METHOD(...)
    message: "axios is banned. Use src/api/http.ts instead."
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - time-os-ui/src/

  - id: no-any-type
    pattern: |
      $X: any
    message: "Avoid 'any' type. Use specific types or 'unknown'."
    languages: [typescript]
    severity: WARNING
    paths:
      include:
        - time-os-ui/src/domain/
        - time-os-ui/src/api/

  # ============================================================================
  # API Route Rules
  # ============================================================================

  - id: api-route-needs-tag
    patterns:
      - pattern: |
          @$ROUTER.$METHOD("$PATH")
          def $FUNC(...):
              ...
      - pattern-not: |
          @$ROUTER.$METHOD("$PATH", tags=[...])
          def $FUNC(...):
              ...
    message: "API routes should have tags for documentation."
    languages: [python]
    severity: WARNING
    paths:
      include:
        - api/

  # ============================================================================
  # Security Rules
  # ============================================================================

  - id: no-hardcoded-secrets
    patterns:
      - pattern-either:
          - pattern: |
              $KEY = "sk-..."
          - pattern: |
              $KEY = "api_key_..."
          - pattern: |
              password = "..."
    message: "Avoid hardcoded secrets. Use environment variables."
    languages: [python]
    severity: ERROR
    paths:
      include:
        - lib/
        - api/
      exclude:
        - "**/*test*.py"

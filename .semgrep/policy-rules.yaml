rules:
  # ============================================================================
  # TIER 1: PR-BLOCKING POLICY RULES
  # ============================================================================
  # High-signal, repo-specific enforcement. Target: <10s, 0 findings.

  # --------------------------------------------------------------------------
  # (1) UI API DISCIPLINE
  # --------------------------------------------------------------------------
  - id: ui-no-direct-fetch
    patterns:
      - pattern-either:
          - pattern: fetch($URL, ...)
          - pattern: fetch($URL)
    message: |
      POLICY: Direct fetch() banned outside API layer. Use 'src/api/http.ts'.
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - "**/time-os-ui/src/**"
      exclude:
        - "**/time-os-ui/src/api/**"
        - "**/__tests__/**"
        - "**/*.test.ts"
        - "**/*.test.tsx"
        # BASELINE [ui-no-direct-fetch]: Legacy files predating API client
        # Why: Pre-existing fetch() usage before http.ts client was established
        # Migration: Replace with http.ts client methods
        # Tracking: TIME-OS-UI-MIGRATION
        # Deadline: Q2 2026
        - "**/time-os-ui/src/lib/api.ts"
        - "**/time-os-ui/src/pages/ClientDetailSpec.tsx"
        - "**/time-os-ui/src/pages/ClientIndex.tsx"
        - "**/time-os-ui/src/pages/ColdClients.tsx"
        - "**/time-os-ui/src/pages/Inbox.tsx"
        - "**/time-os-ui/src/pages/RecentlyActiveDrilldown.tsx"
        - "**/time-os-ui/src/pages/FixData.tsx"

  - id: ui-no-axios
    pattern-either:
      - pattern: axios.$METHOD(...)
      - pattern: axios(...)
    message: |
      POLICY: axios banned. Use 'src/api/http.ts'.
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - "**/time-os-ui/src/**"
      exclude:
        - "**/time-os-ui/src/api/**"
        - "**/__tests__/**"

  # --------------------------------------------------------------------------
  # (2) SUBPROCESS POLICY
  # --------------------------------------------------------------------------
  # Rule 2a: shell=True is banned (injection risk)
  - id: subprocess-no-shell-true
    patterns:
      - pattern-either:
          - pattern: subprocess.run(..., shell=True, ...)
          - pattern: subprocess.call(..., shell=True, ...)
          - pattern: subprocess.Popen(..., shell=True, ...)
          - pattern: subprocess.check_output(..., shell=True, ...)
          - pattern: subprocess.check_call(..., shell=True, ...)
    message: |
      POLICY: shell=True banned (injection risk). Use list args: subprocess.run(["cmd", "arg"])
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
        - "**/scripts/**"
      exclude:
        # BASELINE [subprocess-no-shell-true]: Legacy shell execution
        # Why: Complex piping/quoting for gog CLI tool invocations
        # Migration: Refactor to list args with shutil.which
        # Tracking: SHELL-MIGRATION
        # Deadline: Q2 2026
        - "**/lib/collectors/base.py"
        - "**/lib/executor/handlers.py"

  # Rule 2b: Literal string command banned (must use list)
  - id: subprocess-literal-string-cmd
    patterns:
      - pattern-either:
          - pattern: subprocess.run("...", ...)
          - pattern: subprocess.run(f"...", ...)
          - pattern: subprocess.Popen("...", ...)
          - pattern: subprocess.Popen(f"...", ...)
          - pattern: subprocess.call("...", ...)
          - pattern: subprocess.call(f"...", ...)
    message: |
      POLICY: String command banned. Use list args: subprocess.run(["cmd", "arg"])
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
        - "**/scripts/**"
      exclude:
        # Same baseline as subprocess-no-shell-true
        - "**/lib/collectors/base.py"
        - "**/lib/executor/handlers.py"

  # Rule 2c: git must use shutil.which
  - id: subprocess-bare-git
    patterns:
      - pattern-either:
          - pattern: subprocess.run(["git", ...], ...)
          - pattern: subprocess.Popen(["git", ...], ...)
      - pattern-not-inside: |
          $GIT = shutil.which("git")
          ...
    message: |
      POLICY: Resolve git with shutil.which() first.
      Example: git = shutil.which("git"); subprocess.run([git, "status"])
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
        - "**/scripts/**"
      exclude:
        # BASELINE [subprocess-bare-git]: Uses shutil.which correctly
        # Why: Already resolves git path before invocation
        # Migration: N/A - already compliant
        # Tracking: N/A
        # Deadline: N/A
        - "**/lib/safety/utils.py"

  # Rule 2d: rg must use shutil.which
  - id: subprocess-bare-rg
    patterns:
      - pattern-either:
          - pattern: subprocess.run(["rg", ...], ...)
          - pattern: subprocess.Popen(["rg", ...], ...)
      - pattern-not-inside: |
          $RG = shutil.which("rg")
          ...
    message: |
      POLICY: Resolve rg with shutil.which() first.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
        - "**/scripts/**"
      exclude:
        # BASELINE [subprocess-bare-rg]: Uses shutil.which correctly
        # Why: Already resolves rg path before invocation
        # Migration: N/A - already compliant
        # Tracking: N/A
        # Deadline: N/A
        - "**/lib/safety/schema.py"

  # --------------------------------------------------------------------------
  # (3) SQL POLICY - User Input Injection
  # --------------------------------------------------------------------------
  # High-signal: Catch user-input interpolation in execute(), not all f-strings.
  # DDL patterns (PRAGMA, ALTER, table names) are safe when values are parameterized.

  # Rule 3a: Request params in f-string execute()
  - id: sql-request-param-fstring
    patterns:
      - pattern-either:
          - pattern: $X.execute(f"...{request.$ATTR}...")
          - pattern: $X.execute(f"...{params.$ATTR}...")
          - pattern: $X.execute(f"...{query.$ATTR}...")
          - pattern: $X.execute(f"...{body.$ATTR}...")
          - pattern: $X.execute(f"...{user_input}...")
          - pattern: $X.execute(f"...{user_id}...")
          - pattern: $X.execute(f"...{client_id}...")
          - pattern: cursor.execute(f"...{request.$ATTR}...")
          - pattern: cursor.execute(f"...{params.$ATTR}...")
          - pattern: cursor.execute(f"...{query.$ATTR}...")
          - pattern: cursor.execute(f"...{body.$ATTR}...")
          - pattern: cursor.execute(f"...{user_input}...")
          - pattern: cursor.execute(f"...{user_id}...")
          - pattern: cursor.execute(f"...{client_id}...")
          - pattern: conn.execute(f"...{request.$ATTR}...")
          - pattern: conn.execute(f"...{params.$ATTR}...")
          - pattern: conn.execute(f"...{query.$ATTR}...")
          - pattern: conn.execute(f"...{body.$ATTR}...")
          - pattern: conn.execute(f"...{user_input}...")
          - pattern: conn.execute(f"...{user_id}...")
          - pattern: conn.execute(f"...{client_id}...")
    message: |
      SECURITY: User input interpolated in SQL. Use parameterized queries.
      Example: cursor.execute("SELECT * WHERE id = ?", (user_id,))
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
      exclude:
        - "**/lib/migrations/**"
        - "**/lib/v5/migrations/**"
        - "**/lib/ui_spec_v21/migrations/**"

  # Rule 3b: .format() in execute() - always risky
  - id: sql-format-execute
    patterns:
      - pattern-either:
          - pattern: $X.execute($SQL.format(...), ...)
          - pattern: $X.execute($SQL.format(...))
          - pattern: cursor.execute($SQL.format(...), ...)
          - pattern: cursor.execute($SQL.format(...))
          - pattern: conn.execute($SQL.format(...), ...)
          - pattern: conn.execute($SQL.format(...))
    message: |
      POLICY: .format() in execute() banned. Use parameterized queries.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
      exclude:
        - "**/lib/migrations/**"
        - "**/lib/v5/migrations/**"
        - "**/lib/ui_spec_v21/migrations/**"
        # BASELINE [sql-format-execute]: Safe IN-clause placeholder builder
        # Why: Builds "?,?,?" placeholders, values are parameterized separately
        # Migration: Extract to safe_in_clause() helper
        # Tracking: SQL-HELPERS
        # Deadline: Q3 2026
        - "**/lib/v4/signal_service.py"

  # Rule 3c: % formatting in execute() - always risky
  - id: sql-percent-execute
    patterns:
      - pattern-either:
          - pattern: $X.execute($SQL % $ARGS, ...)
          - pattern: $X.execute($SQL % $ARGS)
          - pattern: cursor.execute($SQL % $ARGS, ...)
          - pattern: cursor.execute($SQL % $ARGS)
          - pattern: conn.execute($SQL % $ARGS, ...)
          - pattern: conn.execute($SQL % $ARGS)
    message: |
      POLICY: % formatting in execute() banned. Use parameterized queries.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
      exclude:
        - "**/lib/migrations/**"
        - "**/lib/v5/migrations/**"
        - "**/lib/ui_spec_v21/migrations/**"

  # --------------------------------------------------------------------------
  # (4) ROUTE LINEAGE: V2 routes MUST use spec_router
  # --------------------------------------------------------------------------
  - id: route-v2-on-app-banned
    pattern-regex: "@app\\.(get|post|put|patch|delete)\\s*\\(\\s*[\"']/api/v2/"
    message: |
      POLICY: V2 routes on @app banned. Use @spec_router in api/spec_router.py.
      The spec_router provides lineage tags=["Spec v2.9"] for OpenAPI.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/api/server.py"

rules:
  # ============================================================================
  # TIER 1: PR-BLOCKING POLICY RULES
  # ============================================================================
  # High-signal only. Target: <10s, 0 findings in clean codebase.

  # --------------------------------------------------------------------------
  # (1) UI API DISCIPLINE
  # --------------------------------------------------------------------------
  - id: ui-no-direct-fetch
    patterns:
      - pattern-either:
          - pattern: fetch($URL, ...)
          - pattern: fetch($URL)
    message: |
      POLICY: Direct fetch() banned outside API layer. Use 'src/api/http.ts'.
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - "**/time-os-ui/src/**"
      exclude:
        - "**/time-os-ui/src/api/**"
        - "**/__tests__/**"
        - "**/*.test.ts"
        - "**/*.test.tsx"
        # BASELINE: Legacy files (migration: Q2 2026)
        - "**/time-os-ui/src/lib/api.ts"
        - "**/time-os-ui/src/pages/ClientDetailSpec.tsx"
        - "**/time-os-ui/src/pages/ClientIndex.tsx"
        - "**/time-os-ui/src/pages/ColdClients.tsx"
        - "**/time-os-ui/src/pages/Inbox.tsx"
        - "**/time-os-ui/src/pages/RecentlyActiveDrilldown.tsx"
        - "**/time-os-ui/src/pages/FixData.tsx"

  - id: ui-no-axios
    pattern-either:
      - pattern: axios.$METHOD(...)
      - pattern: axios(...)
    message: |
      POLICY: axios banned. Use 'src/api/http.ts'.
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      include:
        - "**/time-os-ui/src/**"
      exclude:
        - "**/time-os-ui/src/api/**"
        - "**/__tests__/**"

  # --------------------------------------------------------------------------
  # (2) SUBPROCESS: shell=True banned
  # --------------------------------------------------------------------------
  - id: subprocess-no-shell-true
    patterns:
      - pattern-either:
          - pattern: subprocess.run(..., shell=True, ...)
          - pattern: subprocess.call(..., shell=True, ...)
          - pattern: subprocess.Popen(..., shell=True, ...)
          - pattern: subprocess.check_output(..., shell=True, ...)
          - pattern: subprocess.check_call(..., shell=True, ...)
    message: |
      POLICY: shell=True banned. Use list args: subprocess.run(["cmd", "arg"])
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
        - "**/scripts/**"
      exclude:
        # BASELINE: Legacy (refactor: Q2 2026)
        - "**/lib/collectors/base.py"
        - "**/lib/executor/handlers.py"

  # --------------------------------------------------------------------------
  # (3) SQL: .format() in execute() banned
  # --------------------------------------------------------------------------
  - id: sql-format-execute
    pattern: $CURSOR.execute($SQL.format(...), ...)
    message: |
      POLICY: .format() in execute() banned. Use parameterized queries.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/lib/**"
        - "**/api/**"
      exclude:
        # BASELINE: Safe IN-clause builder (refactor: Q3 2026)
        - "**/lib/v4/signal_service.py"

  # --------------------------------------------------------------------------
  # (4) ROUTE LINEAGE: V2 routes on @app banned in server.py
  # --------------------------------------------------------------------------
  - id: route-v2-on-app-banned
    pattern-regex: "@app\\.(get|post|put|patch|delete)\\s*\\(\\s*[\"']/api/v2/"
    message: |
      POLICY: V2 routes on @app are banned in server.py.
      Use @spec_router in api/spec_router.py for proper lineage tags.
    languages: [python]
    severity: ERROR
    paths:
      include:
        - "**/api/server.py"
